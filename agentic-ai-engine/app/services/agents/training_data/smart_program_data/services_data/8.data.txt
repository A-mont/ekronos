// service.rs example for signless Program with session service module

use sails_rs::{
    prelude::*,
    cell::RefCell,
    gstd::{msg, exec},
    collections::HashMap,
};

// ⚠️ NO TOCAR — requerido por el sistema de sesiones
use crate::{SessionData, Storage};

#[derive(Clone, Default)]
pub struct HelloState {
    pub greeting: String,
    pub user_greetings: HashMap<ActorId, String>,
    pub counter: u64,
}

#[derive(Encode, Decode, TypeInfo)]
#[codec(crate = sails_rs::scale_codec)]
#[scale_info(crate = sails_rs::scale_info)]
pub enum Events {
    Hello,
    PersonalHello(ActorId, String),
    GreetingSet(String),
}

#[derive(Encode, Decode, TypeInfo)]
#[codec(crate = sails_rs::scale_codec)]
#[scale_info(crate = sails_rs::scale_info)]
pub struct IoHelloState {
    pub greeting: String,
    pub user_greetings: Vec<(ActorId, String)>,
    pub counter: u64,
}

impl From<HelloState> for IoHelloState {
    fn from(state: HelloState) -> Self {
        Self {
            greeting: state.greeting,
            user_greetings: state.user_greetings.into_iter().collect(),
            counter: state.counter,
        }
    }
}

/// ✅ Service ligado al estado del Program
pub struct HelloService<'a> {
    state: &'a RefCell<HelloState>,
}

impl<'a> HelloService<'a> {
    pub fn new(state: &'a RefCell<HelloState>) -> Self {
        Self { state }
    }

    fn get(&self) -> core::cell::Ref<'_, HelloState> {
        self.state.borrow()
    }

    fn get_mut(&self) -> core::cell::RefMut<'_, HelloState> {
        self.state.borrow_mut()
    }
}

#[service(events = Events)]
impl<'a> HelloService<'a> {
    #[export]
    pub fn hello_world(
        &mut self,
        session_for_account: Option<ActorId>,
    ) -> Events {
        let msg_src = msg::source();
        let sessions = Storage::get_session_map();

        let _actor = get_actor(
            &sessions,
            &msg_src,
            &session_for_account,
            ActionsForSession::SayHello,
        );

        let mut state = self.get_mut();
        state.counter += 1;

        self.emit_event(Events::Hello).expect("Notification failure");
        Events::Hello
    }

    #[export]
    pub fn personal_hello(
        &mut self,
        name: String,
        session_for_account: Option<ActorId>,
    ) -> Events {
        let msg_src = msg::source();
        let sessions = Storage::get_session_map();

        let actor = get_actor(
            &sessions,
            &msg_src,
            &session_for_account,
            ActionsForSession::SayPersonalHello,
        );

        let message = format!("Hello {} from Vara Network!", name);

        let mut state = self.get_mut();
        state.user_greetings.insert(actor, message);
        state.counter += 1;

        self.emit_event(Events::PersonalHello(actor, name.clone()))
            .expect("Notification failure");

        Events::PersonalHello(actor, name)
    }

    #[export]
    pub fn set_greeting(
        &mut self,
        new_greeting: String,
        session_for_account: Option<ActorId>,
    ) -> Events {
        let msg_src = msg::source();
        let sessions = Storage::get_session_map();

        let _actor = get_actor(
            &sessions,
            &msg_src,
            &session_for_account,
            ActionsForSession::SetGreeting,
        );

        self.get_mut().greeting = new_greeting.clone();

        self.emit_event(Events::GreetingSet(new_greeting.clone()))
            .expect("Notification failure");

        Events::GreetingSet(new_greeting)
    }

    #[export]
    pub fn query_greeting(&self) -> String {
        self.get().greeting.clone()
    }

    #[export]
    pub fn query_user_greeting(&self, user: ActorId) -> Option<String> {
        self.get().user_greetings.get(&user).cloned()
    }

    #[export]
    pub fn query_counter(&self) -> u64 {
        self.get().counter
    }

    #[export]
    pub fn query_state(&self) -> IoHelloState {
        self.get().clone().into()
    }
}

#[derive(Debug, Clone, Encode, Decode, TypeInfo, PartialEq, Eq)]
#[codec(crate = sails_rs::scale_codec)]
#[scale_info(crate = sails_rs::scale_info)]
pub enum ActionsForSession {
    SayHello,
    SayPersonalHello,
    SetGreeting,
}

/// ⚠️ NO CHANGE
fn get_actor(
    session_map: &HashMap<ActorId, SessionData>,
    msg_source: &ActorId,
    session_for_account: &Option<ActorId>,
    actions_for_session: ActionsForSession,
) -> ActorId {
    match session_for_account {
        Some(account) => {
            let session = session_map
                .get(account)
                .expect("No valid session for this account");

            assert!(session.expires > exec::block_timestamp(), "Session expired");
            assert!(
                session.allowed_actions.contains(&actions_for_session),
                "Action not allowed"
            );
            assert_eq!(session.key, *msg_source, "Sender not authorized");
            *account
        }
        None => *msg_source,
    }
}
